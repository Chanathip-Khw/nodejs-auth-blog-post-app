import React, { useState, createContext, useContext } from "react";
import { jwtDecode } from "jwt-decode";
import axios from "axios";
import { useNavigate } from "react-router-dom";

const AuthContext = React.createContext();

function AuthProvider(props) {
  const [state, setState] = useState({
    loading: null,
    error: null,
    user: null,
  });
  const navigate = useNavigate();

  const login = async (username, password) => {
    // üê® Todo: Exercise #4
    //  ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Logic ‡∏Ç‡∏≠‡∏á Function `login` ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    //  Function `login` ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á Request ‡πÑ‡∏õ‡∏ó‡∏µ‡πà API POST /login
    //  ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö Body ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏ß‡πâ
    setState((prevState) => ({ ...prevState, loading: true, error: null }));
    try {
      const response = await axios.post("http://localhost:4000/login", {
        username: username,
        password: password,
      });

      const token = response.data.token;
      localStorage.setItem("token", token);
      const decodeUser = jwtDecode(token);
      setState({
        loading: false,
        error: null,
        user: decodeUser,
      });
      navigate("/");
    } catch (error) {
      console.error(
        "Login failed",
        error.response ? error.response.data : error.message
      );
      setState({
        loading: false,
        error: error.response ? error.response.data : error.message,
        user: null,
      });
    }
  };

  const register = () => {
    // üê® Todo: Exercise #2
    //  ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Logic ‡∏Ç‡∏≠‡∏á Function `register` ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    //  Function register ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á Request ‡πÑ‡∏õ‡∏ó‡∏µ‡πà API POST /register
    //  ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö Body ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏ß‡πâ
  };

  const logout = () => {
    // üê® Todo: Exercise #7
    //  ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Logic ‡∏Ç‡∏≠‡∏á Function `logout` ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    //  Function logout ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö JWT Token ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Local Storage
    localStorage.removeItem("token");
    setState({
      loading: false,
      error: null,
      user: null,
    });
  };

  const isAuthenticated = Boolean(localStorage.getItem("token"));

  return (
    <AuthContext.Provider
      value={{ state, login, logout, register, isAuthenticated }}
    >
      {props.children}
    </AuthContext.Provider>
  );
}

// this is a hook that consume AuthContext
const useAuth = () => React.useContext(AuthContext);

export { AuthProvider, useAuth };
